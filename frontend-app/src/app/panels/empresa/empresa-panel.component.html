<div class="empresa-panel container">
  <div class="left-card card">
    <h3>Empresas</h3>
    <div *ngIf="loading" class="muted">Cargando...</div>
    <div *ngIf="error" class="muted">{{error}}</div>

    <div class="company-list">
      <ul>
        <li *ngFor="let c of companies" (click)="selectCompany(c)" [class.active]="selectedCompany?.id===c.id">
          <strong>{{c.nombre}}</strong>
          <div class="small muted">ID: {{c.id}}</div>
        </li>
      </ul>
    </div>

    <div class="modules" *ngIf="selectedCompany">
      <h4>Panel: {{selectedCompany.nombre}}</h4>
      <nav class="module-nav">
        <button (click)="switchModule('catalog')" [class.active]="selectedModule==='catalog'">üéÆ Gesti√≥n de juegos</button>
        <button (click)="switchModule('users')" [class.active]="selectedModule==='users'">üßë‚Äçüíº Usuarios</button>
        <button (click)="switchModule('comments')" [class.active]="selectedModule==='comments'">üí¨ Comentarios</button>
        <button (click)="switchModule('analytics')" [class.active]="selectedModule==='analytics'">üìä Analytics</button>
        <button (click)="switchModule('billing')" [class.active]="selectedModule==='billing'">üßæ Facturaci√≥n</button>
        <button (click)="switchModule('settings')" [class.active]="selectedModule==='settings'">‚öôÔ∏è Configuraci√≥n</button>
      </nav>
    </div>
  </div>

  <main class="card main-area">
      <div *ngIf="!selectedCompany" class="muted">Selecciona una empresa para ver el panel de control.</div>

      <div *ngIf="formMessage" class="notification" [class.success]="formMessage.type==='success'" [class.error]="formMessage.type==='error'">
        {{formMessage.text}}
      </div>

    <section *ngIf="selectedCompany && selectedModule==='catalog'">
      <h3 style="display:flex;align-items:center;gap:0.6rem">Cat√°logo ‚Äî {{selectedCompany.nombre}} <button class="small" (click)="createDemoGames()" [disabled]="creatingDemos">{{ creatingDemos ? 'Creando...' : 'Insertar demos' }}</button></h3>
      <div class="metrics-row" style="margin:0.6rem 0 1rem 0">
        <div class="metric">
          <div class="metric-title">Total juegos</div>
          <div class="metric-value">{{metrics.totalGames}}</div>
        </div>
        <div class="metric">
          <div class="metric-title">Publicados</div>
          <div class="metric-value">{{metrics.published}}</div>
        </div>
        <div class="metric">
          <div class="metric-title">Precio promedio</div>
          <div class="metric-value">{{metrics.avgPrice | currency:'USD': 'symbol':'1.2-2'}}</div>
        </div>
        <div class="metric">
          <div class="metric-title">Ingreso estimado</div>
          <div class="metric-value">{{metrics.estimatedRevenue | currency:'USD': 'symbol':'1.2-2'}}</div>
        </div>
      </div>
      <div *ngIf="catalog.length===0" class="muted">Sin juegos en el cat√°logo.</div>
      <div *ngFor="let group of groupedCatalog" class="category-group" style="margin-bottom:1rem">
        <h4 style="margin:0.4rem 0;padding:0.3rem 0.6rem;background:#f6f7fb;border-radius:6px">{{group.categoria}}</h4>
        <ul class="users-list">
          <li *ngFor="let g of group.items" class="catalog-item" style="padding:0.6rem 0;border-bottom:1px solid #f0f0f0">
            <div style="display:flex;gap:0.8rem;align-items:center">
              <img [src]="g.url_imagen || 'https://via.placeholder.com/160x90?text=No+Image'" [alt]="g.nombre" style="width:120px;height:68px;object-fit:cover;border-radius:6px;border:1px solid #ddd"/>
              <div style="flex:1">
                <strong style="display:block">{{g.nombre}}</strong>
                <div class="small muted">{{g.categoria}} ‚Ä¢ Precio: {{g.precio | number:'1.2-2'}} ‚Ä¢ {{g.estado || (g.for_sale? 'A la venta':'Suspendido')}}</div>
                <div class="small muted" *ngIf="g.descripcion" style="margin-top:6px">{{g.descripcion}}</div>
              </div>
              <div style="display:flex;flex-direction:column;gap:0.4rem">
                <button (click)="editGame(g)">Editar</button>
                <button (click)="toggleSale(g)">{{g.for_sale ? 'Suspender' : 'Reactivar'}}</button>
                <button (click)="sendToAdmin(g)">Mandar a admin para aprobaci√≥n</button>
                <button class="danger" (click)="removeGame(g)">Eliminar</button>
              </div>
            </div>
          </li>
        </ul>
      </div>

      <div style="margin-top:0.6rem">
        <h5>Crear videojuego</h5>
        <input placeholder="Nombre" [(ngModel)]="newGameName" />
        <input placeholder="Precio" type="number" [(ngModel)]="newGamePrice" />
        <input placeholder="URL imagen (opcional)" [(ngModel)]="newGameImage" />
        <input placeholder="Categor√≠a (opcional)" [(ngModel)]="newGameCategory" />
        <textarea placeholder="Descripci√≥n" rows="3" [(ngModel)]="newGameDesc"></textarea>
        <div *ngIf="newGameImage" style="margin:6px 0"><img [src]="newGameImage" alt="preview" style="max-width:140px;border-radius:6px;border:1px solid #ddd"/></div>
        <div class="form-errors" *ngIf="gameFormErrors.length>0">
          <div *ngFor="let e of gameFormErrors">‚Ä¢ {{e}}</div>
        </div>
        <div style="margin-top:0.4rem"><button (click)="createGame()" [disabled]="newGameName.trim()==='' || creatingGame">{{ creatingGame ? 'Creando...' : 'Crear juego' }}</button></div>
      </div>

      <div *ngIf="editingGame" style="margin-top:0.75rem;border-top:1px solid #eee;padding-top:0.6rem">
        <h5>Editar: {{editingGame.nombre}}</h5>
        <input placeholder="Nombre" [(ngModel)]="editingGame.nombre" />
        <input placeholder="Precio" type="number" [(ngModel)]="editingGame.precio" />
        <input placeholder="URL imagen (opcional)" [(ngModel)]="editingGame.url_imagen" />
        <input placeholder="Categor√≠a (opcional)" [(ngModel)]="editingGame.categoria" />
        <textarea placeholder="Descripci√≥n" rows="3" [(ngModel)]="editingGame.descripcion"></textarea>
        <div *ngIf="editingGame?.url_imagen" style="margin:6px 0"><img [src]="editingGame.url_imagen" alt="preview" style="max-width:140px;border-radius:6px;border:1px solid #ddd"/></div>
        <div style="margin-top:0.4rem"><button (click)="saveGame()">Guardar</button> <button (click)="editingGame=null">Cancelar</button></div>
      </div>
    </section>

    <section *ngIf="selectedCompany && selectedModule==='users'">
      <h3>Usuarios internos ‚Äî {{selectedCompany.nombre}}</h3>
      <div *ngIf="users.length===0" class="muted">Sin usuarios.</div>
      <ul class="users-list">
        <li *ngFor="let u of users">
          <span>{{u.correo || u.email}} <small class="muted">({{u.role}})</small></span>
          <button class="danger" (click)="removeUser(u)">Eliminar</button>
        </li>
      </ul>
      <div class="add-user">
        <input placeholder="email@empresa.com" [(ngModel)]="newUserEmail" />
        <button (click)="addUser()">Agregar usuario</button>
      </div>
    </section>

    <section *ngIf="selectedCompany && selectedModule==='comments'">
      <h3>Comentarios y rese√±as</h3>
      <p class="muted">Visibilidad global: <strong>{{commentVisibilityGlobal ? 'Visible' : 'Oculto'}}</strong></p>
      <button (click)="toggleCommentVisibilityGlobal()">Alternar visibilidad (cliente)</button>
      <p class="small muted">Persistencia de visibilidad requiere backend.</p>
    </section>

    <section *ngIf="selectedCompany && selectedModule==='analytics'">
      <h3>Analytics ‚Äî Resumen</h3>
      <div class="metrics-row" style="margin:0.6rem 0 1rem 0">
        <div class="metric">
          <div class="metric-title">Total juegos</div>
          <div class="metric-value">{{metrics.totalGames}}</div>
        </div>
        <div class="metric">
          <div class="metric-title">Publicados</div>
          <div class="metric-value">{{metrics.published}}</div>
        </div>
        <div class="metric">
          <div class="metric-title">Precio promedio</div>
          <div class="metric-value">{{metrics.avgPrice | currency:'USD': 'symbol':'1.2-2'}}</div>
        </div>
        <div class="metric">
          <div class="metric-title">Ingreso estimado</div>
          <div class="metric-value">{{metrics.estimatedRevenue | currency:'USD': 'symbol':'1.2-2'}}</div>
        </div>
      </div>
      <h4>Top categor√≠as</h4>
      <div *ngIf="groupedCatalog.length===0" class="muted">No hay datos de cat√°logo disponibles.</div>
      <ul *ngIf="groupedCatalog.length>0" class="users-list">
        <li *ngFor="let g of groupedCatalog"> <strong>{{g.categoria}}</strong> <span class="muted">({{g.items.length}} juegos)</span></li>
      </ul>
      <p class="small muted">Nota: m√©tricas calculadas desde el cat√°logo cargado localmente; para m√©tricas reales integra las APIs de ventas y compras.</p>
    </section>

    <section *ngIf="selectedCompany && selectedModule==='billing'">
      <h3>Facturaci√≥n y comisiones</h3>
      <div class="muted">Comisiones: pendiente de integraci√≥n con pagos.</div>

      <div class="billing-actions" style="margin-top:0.6rem">
        <p class="small muted">Reportes para due√±os de empresa (PDF - JasperReports preferido):</p>
        <div style="display:flex;gap:0.6rem;flex-wrap:wrap;align-items:center">
          <button class="btn-report" title="Generar reporte de ventas (Jasper PDF si est√° disponible)" (click)="generateSalesReport()" [disabled]="reportLoading.ventas">{{ reportLoading.ventas ? 'Generando ventas‚Ä¶' : 'üìà Reporte de Ventas (PDF)' }}</button>
          <button class="btn-report" title="Generar reporte de feedback (calificaciones y comentarios)" (click)="generateFeedbackReport()" [disabled]="reportLoading.feedback">{{ reportLoading.feedback ? 'Generando feedback‚Ä¶' : 'üí¨ Reporte de Feedback (PDF)' }}</button>
          <button class="btn-report" title="Generar Top 5 juegos (por ventas)" (click)="generateTop5Report()" [disabled]="reportLoading.top5">{{ reportLoading.top5 ? 'Generando Top5‚Ä¶' : 'üèÜ Top 5 Juegos (PDF)' }}</button>
        </div>

        <div style="margin-top:0.6rem;display:flex;gap:0.6rem;align-items:center">
          <small class="muted">Estado:</small>
          <span class="badge" *ngIf="reportStatus.ventas==='ok-backend'">Ventas: PDF (backend)</span>
          <span class="badge muted" *ngIf="reportStatus.ventas==='fallback-json'">Ventas: JSON (fallback)</span>
          <span class="badge" *ngIf="reportStatus.feedback==='ok-backend'">Feedback: PDF (backend)</span>
          <span class="badge muted" *ngIf="reportStatus.feedback==='fallback-json'">Feedback: JSON (fallback)</span>
          <span class="badge" *ngIf="reportStatus.top5==='ok-backend'">Top5: PDF (backend)</span>
          <span class="badge muted" *ngIf="reportStatus.top5==='fallback-json'">Top5: JSON (fallback)</span>
        </div>
        <p class="small muted" style="margin-top:0.4rem">Si el backend no responde se exportar√° un resumen local (JSON). Para obtener PDFs n√≠tidos use la ruta JasperReports en el backend.</p>
      </div>
    </section>

    <section *ngIf="selectedCompany && selectedModule==='settings'">
      <h3>Configuraci√≥n de empresa</h3>

      <div *ngIf="selectedCompany" class="company-settings">
        <div class="mb-2"><strong>Nombre:</strong> {{selectedCompany.nombre || selectedCompany.name || selectedCompany.razon_social}}</div>
        <div class="mb-2"><strong>ID:</strong> {{selectedCompany.id || selectedCompany.companyId || selectedCompany.public_id}}</div>
        <div class="mb-2"><strong>Correo:</strong> {{ getLoggedUserEmail() || (selectedCompany.contact_email || selectedCompany.email || selectedCompany.correo) || 'N/A' }}</div>
        <div class="mb-2"><strong>Fecha registro:</strong> {{ getCompanyCreationDate() || 'N/A' }}</div>
        <div class="mb-2"><strong>Juegos publicados:</strong> {{ metrics.published }}</div>

        <div class="mb-2">
          <label class="form-check-label mr-2">Visible para gamers</label>
          <input type="checkbox" class="form-check-input" [checked]="(selectedCompany.visible_to_gamers ?? selectedCompany.visible ?? false)" (change)="toggleCompanyVisibility()" />
        </div>
      </div>

      <div *ngIf="!selectedCompany" class="muted">Seleccione una empresa para ver la configuraci√≥n</div>
    </section>
  </main>
</div>
