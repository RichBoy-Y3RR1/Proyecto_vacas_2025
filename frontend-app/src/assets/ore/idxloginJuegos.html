<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Login Juegos — Demo</title>
  <link rel="stylesheet" href="assets/ore/login.css" />
</head>
<body>
  <div class="page">
    <div class="wrap">
      <div class="header">
        <div class="brand">Ingreso / Registro — Tienda de Videojuegos</div>
      </div>
      <p class="muted">Este archivo está en <code>assets/ore/idxloginJuegos.html</code>. Usa las APIs: <code>/api/auth/*</code> y <code>/api/videojuegos</code>.</p>

      <div class="cols">
      <div class="col" id="left">
        <h3>Iniciar sesión</h3>
        <div id="loginMsg" class="msg" style="display:none"></div>
        <label>Email <input id="loginEmail" type="email" /></label>
        <label>Contraseña <input id="loginPassword" type="password" /></label>
        <div class="actions">
          <button id="btnLogin">Entrar</button>
          <button id="btnLogout" class="secondary" style="display:none">Salir</button>
        </div>

        <hr />
        <h3>Registro rápido</h3>
        <div id="regMsg" class="msg" style="display:none"></div>
        <label>Tipo
          <select id="regType"><option value="USUARIO">Gamer</option><option value="EMPRESA">Empresa</option></select>
        </label>
        <label>Email <input id="regEmail" type="email" /></label>
        <label>Contraseña <input id="regPassword" type="password" /></label>
        <label id="labelNick">Nickname <input id="regNick" type="text" /></label>
        <label id="labelName" style="display:none">Nombre Empresa <input id="regName" type="text" /></label>
        <div class="actions">
          <button id="btnRegGamer">Registrar Gamer</button>
          <button id="btnRegEmpresa">Registrar Empresa</button>
        </div>
      </div>

      <div class="col" id="right">
        <h3>Estado sesión</h3>
        <div id="who" class="small muted">No autenticado</div>

        <h3 style="margin-top:16px">Videojuegos (demo)</h3>
        <div id="gamesMsg" class="msg" style="display:none"></div>
        <div id="gamesList" class="games-list small muted">Cargando...</div>

        <div id="createBox" class="create-box">
          <h4>Crear videojuego</h4>
          <div id="createMsg" class="msg" style="display:none"></div>
          <label>Nombre <input id="gNombre" type="text" /></label>
          <label>Precio <input id="gPrecio" type="number" step="0.01" value="0" /></label>
          <div style="margin-top:8px"><button id="btnCreate">Crear (solo ADMIN/EMPRESA)</button></div>
        </div>
      </div>
    </div>

      <p class="small muted" style="margin-top:18px">Usuarios de prueba: admin@tienda.com/admin123, empresa@acme.com/empresa123, user@cliente.com/user123</p>
    </div>
  </div>

  <script>
    const base = '/api';
    function show(el, txt, ok=true){ el.style.display='block'; el.className='msg '+(ok?'ok':'err'); el.textContent=txt }
    function hide(el){ el.style.display='none'; el.textContent=''; }

    async function loadGames(){
      const list = document.getElementById('gamesList'); list.textContent = 'Cargando...';
      try{ const r = await fetch(base+'/videojuegos'); if(!r.ok) throw r; const data = await r.json(); if(!Array.isArray(data)) { list.textContent = JSON.stringify(data) } else { list.innerHTML = data.map(v=>`• <strong>${v.nombre}</strong> — ${v.descripcion||'-'} — ${v.precio}`).join('<br/>') } }
      catch(e){ list.textContent = 'No se pudo cargar videojuegos.' }
    }

    function setWho(user){ const who = document.getElementById('who'); if(!user){ who.textContent='No autenticado'; document.getElementById('btnLogout').style.display='none'; } else { who.innerHTML = `<strong>${user.nickname||user.email}</strong> — <em>${user.role}</em>`; document.getElementById('btnLogout').style.display='inline-block'; } }

    async function login(){ const em=document.getElementById('loginEmail').value; const pw=document.getElementById('loginPassword').value; const lm=document.getElementById('loginMsg'); hide(lm); try{ const res=await fetch(base+'/auth/login',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({email:em,password:pw})}); if(!res.ok) throw res; const j=await res.json(); localStorage.setItem('auth', JSON.stringify(j)); setWho(j.user); show(lm,'Login correcto'); loadGames(); }catch(e){ show(lm,'Credenciales inválidas',false) } }

    async function register(type){ const em=document.getElementById('regEmail').value; const pw=document.getElementById('regPassword').value; const lm=document.getElementById('regMsg'); hide(lm); if(!em||!pw){ show(lm,'Email y contraseña requeridos',false); return }
      const payload = { role: type, email: em, password: pw };
      if(type==='USUARIO') payload.nickname = document.getElementById('regNick').value || ('gamer'+Math.floor(Math.random()*1000));
      if(type==='EMPRESA') payload.name = document.getElementById('regName').value || ('Empresa'+Math.floor(Math.random()*100));
      try{ const res = await fetch(base+'/auth/register',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(payload)}); if(!res.ok) throw res; const j=await res.json(); // store demo auth
        const auth = { token:'demo-token', user: { email:payload.email, role:payload.role, nickname:payload.nickname, name:payload.name } };
        localStorage.setItem('auth', JSON.stringify(auth)); setWho(auth.user); show(lm,'Registro correcto'); loadGames(); }catch(e){ show(lm,'Error al registrar',false); }
    }

    function logout(){ localStorage.removeItem('auth'); setWho(null); show(document.getElementById('loginMsg'),'Sesión cerrada'); }

    async function createGame(){ const nm=document.getElementById('gNombre').value; const pr=parseFloat(document.getElementById('gPrecio').value||0); const cm=document.getElementById('createMsg'); hide(cm);
      const s = localStorage.getItem('auth'); let user=null; try{ user = s?JSON.parse(s).user:null }catch(e){}
      if(!user || !(user.role==='ADMIN' || user.role==='EMPRESA')){ show(cm,'No tienes permiso para crear',false); return }
      if(!nm || !pr){ show(cm,'Nombre y precio requeridos',false); return }
      try{ const res = await fetch(base+'/videojuegos',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({nombre:nm,descripcion:'',precio:pr})}); if(!res.ok) throw res; show(cm,'Videojuego creado'); document.getElementById('gNombre').value=''; document.getElementById('gPrecio').value='0'; loadGames(); }catch(e){ show(cm,'Error al crear videojuego',false) }
    }

    // wiring
    document.getElementById('btnLogin').addEventListener('click', e=>{ e.preventDefault(); login(); });
    document.getElementById('btnLogout').addEventListener('click', e=>{ e.preventDefault(); logout(); });
    document.getElementById('btnRegGamer').addEventListener('click', e=>{ e.preventDefault(); register('USUARIO'); });
    document.getElementById('btnRegEmpresa').addEventListener('click', e=>{ e.preventDefault(); register('EMPRESA'); });
    document.getElementById('regType').addEventListener('change', e=>{
      const v=e.target.value; document.getElementById('labelNick').style.display = v==='USUARIO'?'block':'none'; document.getElementById('labelName').style.display = v==='EMPRESA'?'block':'none';
    });
    document.getElementById('btnCreate').addEventListener('click', e=>{ e.preventDefault(); createGame(); });

    // init
    try{ const s = localStorage.getItem('auth'); if(s){ const a = JSON.parse(s); setWho(a.user||a); } }catch(e){}
    loadGames();
  </script>
</body>
</html>

