<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Tienda Videojuegos</title>
</head>
<body>
  <h1>Tienda Videojuegos - Backend</h1>
  <p>Este WAR puede servir el frontend compilado en <code>/browser</code>.</p>
  <h2>Endpoints disponibles — Interfaz de prueba</h2>
  <p>
 <code>/backend</code> la URL base será <code>http://localhost:8080/backend</code>.</p>

  <div style="display:flex;gap:20px;align-items:flex-start;">
    <div style="flex:1;min-width:360px">
      <label><strong>Context (detectado)</strong>: <span id="ctxSpan"></span></label>
      <div style="margin-top:8px">
        <label>Token (opcional): <input id="tokenInput" style="width:100%" placeholder="pegar token JWT aquí"></label>
      </div>
      <div style="margin-top:8px">
        <label><input type="checkbox" id="mockAuthCheckbox"> Usar autenticación local (mock) — permite entrar como admin sin backend</label>
      </div>

      <div style="margin-top:12px">
        <label>Seleccionar endpoint:</label>
        <select id="endpointSelect" style="width:100%;height:34px"></select>
      </div>

      <div style="margin-top:8px">
        <label>ID (si aplica): <input id="idInput" style="width:100%" placeholder="usar para {id} o {usuarioId}"></label>
      </div>

      <div style="margin-top:8px">
        <label>Cuerpo JSON (POST/PUT):</label>
        <textarea id="bodyInput" style="width:100%;height:120px" placeholder='{"email":"user@example.com","password":"123"}'></textarea>
      </div>

      <div style="margin-top:8px;display:flex;gap:8px">
        <button id="callBtn">Llamar endpoint</button>
        <button id="fillExampleBtn">Auto-fill ejemplo</button>
        <button id="seedLocalBtn" title="Crea usuarios de prueba en localStorage">Seed local users</button>
        <a id="openapiLink" style="margin-left:auto;align-self:center">OpenAPI</a>
      </div>
      <div style="margin-top:12px;border-top:1px dashed #ddd;padding-top:8px">
        <strong>Admin Mock Panel</strong>
        <div style="margin-top:8px;display:flex;gap:8px;align-items:center">
          <button id="showLocalUsersBtn">Mostrar usuarios locales</button>
          <button id="createAdminBtn">Crear admin local (admin@tienda.com/admin123)</button>
          <button id="promoteBtn">Promover user@cliente.com a ADMIN</button>
          <button id="clearLocalBtn">Borrar usuarios locales</button>
        </div>
        <pre id="adminResult" style="background:#f9f9f9;border:1px solid #eee;padding:8px;margin-top:8px;max-height:220px;overflow:auto"></pre>
      </div>
    </div>

    <div style="flex:1;min-width:360px">
      <label><strong>Resultado</strong>:</label>
      <div style="margin-top:8px"><strong>Estado:</strong> <span id="statusSpan">-</span></div>
      <pre id="resultPre" style="background:#f6f6f6;border:1px solid #ddd;padding:8px;height:420px;overflow:auto"></pre>
    </div>
  </div>

  <script>
    const endpoints = [
      {name:'Login', method:'POST', path:'/api/auth/login', example:{email:'admin@example.com',password:'123'}},
      {name:'Logout', method:'POST', path:'/api/auth/logout'},
      {name:'Refresh', method:'POST', path:'/api/auth/refresh'},
      {name:'List videojuegos', method:'GET', path:'/api/videojuegos'},
      {name:'Get videojuego by id', method:'GET', path:'/api/videojuegos/{id}'},
      {name:'Create videojuego', method:'POST', path:'/api/videojuegos', example:{titulo:'Mi Juego',precio:9.99,categoriaId:1}},
      {name:'Update videojuego', method:'PUT', path:'/api/videojuegos/{id}', example:{titulo:'Mi Juego mod'}},
      {name:'Delete videojuego', method:'DELETE', path:'/api/videojuegos/{id}'},
      {name:'List usuarios', method:'GET', path:'/api/usuarios'},
      {name:'Create usuario', method:'POST', path:'/api/usuarios', example:{email:'user@example.com',password:'123',rol:'USUARIO'}},
      {name:'List empresas', method:'GET', path:'/api/empresas'},
      {name:'Create empresa', method:'POST', path:'/api/empresas', example:{nombre:'Mi Empresa',email:'empresa@example.com'}},
      {name:'Update empresa', method:'PUT', path:'/api/empresas/{id}', example:{nombre:'Nombre nuevo'}},
      {name:'Delete empresa', method:'DELETE', path:'/api/empresas/{id}'},
      {name:'Create compra', method:'POST', path:'/api/compras', example:{videojuegoId:1,usuarioId:1}},
      {name:'Get comisiones', method:'GET', path:'/api/comisiones'},
      {name:'Update comisiones', method:'PUT', path:'/api/comisiones', example:{porcentaje:10}},
      {name:'List comentarios', method:'GET', path:'/api/comentarios'},
      {name:'Create comentario', method:'POST', path:'/api/comentarios', example:{videojuegoId:1,usuarioId:1, texto:'Gran juego!'}},
      {name:'List categorias', method:'GET', path:'/api/categorias'},
      {name:'Create categoria', method:'POST', path:'/api/categorias', example:{nombre:'Acción'}},
      {name:'List banners', method:'GET', path:'/api/banner'},
      {name:'Create banner', method:'POST', path:'/api/banner', example:{titulo:'Promo',url:'/assets/promo.png'}},
      {name:'Get reportes', method:'GET', path:'/api/reportes'},
      {name:'Get reportes PDF', method:'GET', path:'/api/reportes?format=pdf'},
      {name:'Get cartera', method:'GET', path:'/api/cartera/{usuarioId}'},
      {name:'Recargar cartera', method:'POST', path:'/api/cartera', example:{usuarioId:1,monto:50}}
    ];

    const ctx = (function(){
      const parts = location.pathname.split('/').filter(Boolean);
      return parts[0] || '';
    })();

    document.getElementById('ctxSpan').textContent = ctx || '(root)';
    const sel = document.getElementById('endpointSelect');
    endpoints.forEach((e,i)=>{
      const opt = document.createElement('option');
      opt.value = i;
      opt.text = `[${e.method}] ${e.name} — ${e.path}`;
      sel.appendChild(opt);
    });

    document.getElementById('openapiLink').href = '/' + ctx + '/openapi.yaml';
    document.getElementById('openapiLink').textContent = 'OpenAPI';

    function buildUrl(pathTemplate, idVal){
      let path = pathTemplate.replace('{id}', encodeURIComponent(idVal||'')).replace('{usuarioId}', encodeURIComponent(idVal||''));
      // ensure we don't end with //
      return '/' + ctx + path;
    }

    document.getElementById('fillExampleBtn').addEventListener('click', ()=>{
      const ep = endpoints[sel.value];
      if(ep && ep.example) document.getElementById('bodyInput').value = JSON.stringify(ep.example, null, 2);
      else document.getElementById('bodyInput').value = '';
    });

    document.getElementById('callBtn').addEventListener('click', async ()=>{
      const ep = endpoints[sel.value];
      const idVal = document.getElementById('idInput').value.trim();
      const token = document.getElementById('tokenInput').value.trim();
      let url = buildUrl(ep.path, idVal);
      const opts = { method: ep.method, headers: {} };
      if(ep.method === 'POST' || ep.method === 'PUT'){
        const txt = document.getElementById('bodyInput').value.trim();
        if(txt){
          try{ opts.body = JSON.stringify(JSON.parse(txt)); opts.headers['Content-Type']='application/json'; }
          catch(e){ alert('JSON inválido en el cuerpo: '+e.message); return; }
        }
      }
      if(token){ opts.headers['Authorization'] = 'Bearer ' + token; }

      const statusSpan = document.getElementById('statusSpan');
      const pre = document.getElementById('resultPre');
      statusSpan.textContent = '...' ; pre.textContent = 'Pinging ' + url + ' ...';
      // If mock auth enabled and this is a login call, handle locally
      try{
        const mockEnabled = document.getElementById('mockAuthCheckbox').checked;
        if (mockEnabled && ep.path === '/api/auth/login' && (ep.method === 'POST')){
          let bodyObj = {};
          try { bodyObj = opts.body ? JSON.parse(opts.body) : {}; } catch(e){}
          const mock = handleMockLogin(bodyObj);
          statusSpan.textContent = mock.status + ' ' + (mock.status===200? 'OK':'ERROR');
          pre.textContent = JSON.stringify(mock.body, null, 2);
          return;
        }

        const res = await fetch(url, opts);
        statusSpan.textContent = res.status + ' ' + res.statusText;
        const ct = res.headers.get('content-type') || '';
        if(ct.includes('application/json')){
          const j = await res.json(); pre.textContent = JSON.stringify(j,null,2);
        } else if(ct.includes('application/pdf')){
          pre.textContent = 'PDF received — abrir en nueva pestaña';
          const blob = await res.blob();
          const u = URL.createObjectURL(blob); window.open(u,'_blank');
        } else {
          const txt = await res.text(); pre.textContent = txt;
        }
      }catch(err){
        statusSpan.textContent = 'ERROR';
        pre.textContent = 'Error al llamar endpoint:\n' + err.toString();
      }
    });

    // seed local users into localStorage for mock auth
    document.getElementById('seedLocalBtn').addEventListener('click', ()=>{
      seedLocalUsers();
      alert('Usuarios locales creados: admin@tienda.com/admin123, empresa@acme.com/empresa123, user@cliente.com/user123');
    });

    // Admin Mock Panel handlers
    document.getElementById('showLocalUsersBtn').addEventListener('click', ()=>{
      const out = document.getElementById('adminResult');
      const users = JSON.parse(localStorage.getItem('local_users') || '[]');
      out.textContent = JSON.stringify(users, null, 2);
    });
    document.getElementById('createAdminBtn').addEventListener('click', ()=>{
      const out = document.getElementById('adminResult');
      seedLocalUsers();
      // ensure admin exists
      const users = JSON.parse(localStorage.getItem('local_users') || '[]');
      const adm = users.find(u=>u.email==='admin@tienda.com');
      if(!adm){ users.push({id:Date.now(), email:'admin@tienda.com', password:'admin123', role:'ADMIN', nickname:'admin'}); localStorage.setItem('local_users', JSON.stringify(users)); out.textContent='Admin creado.'; }
      else out.textContent='Admin ya existe.';
    });
    document.getElementById('promoteBtn').addEventListener('click', ()=>{
      const out = document.getElementById('adminResult');
      const users = JSON.parse(localStorage.getItem('local_users') || '[]');
      const target = users.find(u=>u.email==='user@cliente.com' || u.email==='gamer@example.com');
      if(!target){ out.textContent='Usuario objetivo no encontrado. Ejecuta "Seed local users" primero.'; return; }
      target.role='ADMIN';
      localStorage.setItem('local_users', JSON.stringify(users));
      out.textContent = 'Usuario promovido a ADMIN:\n' + JSON.stringify(target, null, 2);
    });
    document.getElementById('clearLocalBtn').addEventListener('click', ()=>{
      localStorage.removeItem('local_users'); localStorage.removeItem('local_companies'); document.getElementById('adminResult').textContent='Local users cleared';
    });

    function seedLocalUsers(){
      const users = [
        {id:1,email:'admin@tienda.com',password:'admin123',role:'ADMIN',nickname:'admin'},
        {id:2,email:'empresa@acme.com',password:'empresa123',role:'EMPRESA',nickname:'acme_user',empresaId:1},
        {id:3,email:'user@cliente.com',password:'user123',role:'USUARIO',nickname:'gamer123'}
      ];
      localStorage.setItem('mock_users', JSON.stringify(users));
    }

    function handleMockLogin(body){
      const users = JSON.parse(localStorage.getItem('mock_users') || '[]');
      const email = (body.email || '').toLowerCase().trim();
      const password = body.password || '';
      const found = users.find(u => u.email.toLowerCase() === email);
      if (!found) return { status:401, body:{ error:'invalid', message:'usuario no encontrado (mock)' } };
      if (found.password !== password) return { status:401, body:{ error:'invalid', message:'contraseña incorrecta (mock)' } };
      const token = 'mock-token-'+found.id+'-'+Date.now();
      const userMap = { id: found.id, email: found.email, role: found.role };
      if (found.empresaId) { userMap.companyId = found.empresaId; userMap.empresaId = found.empresaId; userMap.empresa_id = found.empresaId; }
      return { status:200, body: { token: token, user: userMap } };
    }
  </script>

</body>
</html>